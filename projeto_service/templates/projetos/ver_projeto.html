{% extends "../base/base.html" %}
{% block template %}
<div class="container mx-auto px-4 py-8">
    <!-- Botão flutuante -->
    <button type="button" onclick="mostrarFormulario()"
            class="fixed bottom-24 right-6 z-50 w-14 h-14 bg-green-500 hover:bg-green-600 text-white rounded-full shadow-lg flex items-center justify-center">
        <i class="bi bi-person-plus text-xl"></i>
    </button>

    <!-- Título e Descrição -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800" id="nome"></h2>
        <p class="text-gray-600 mt-2" id="descricao"></p>
    </div>

    <!-- Grid de informações -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Detalhes do Projeto -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Detalhes do Projeto</h3>
            <div class="space-y-3">
                <p class="text-gray-700" id="dataInicio"></p>
                <p class="text-gray-700" id="dataFinal"></p>
                <p class="text-gray-700" id="status"></p>
            </div>
        </div>

        <!-- Responsáveis -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Responsáveis</h3>
            <ul class="space-y-3" id="listaResponsaveis">
                <li class="text-gray-700" id="desenvolvedor"></li>
                <li class="text-gray-700" id="analista"></li>
                <li class="text-gray-700" id="orgao"></li>
            </ul>
        </div>
    </div>

    <!-- Tarefas -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-gray-800">Tarefas do Projeto</h3>
            <a href="../../../tarefas/cadastrar_tarefa/{{ projeto_id }}">
                <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md flex items-center">
                    <i class="bi bi-plus-lg mr-2"></i>Criar nova tarefa
                </button>
            </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Tarefas Ativas -->
            <div>
                <h4 class="text-blue-600 font-medium mb-3">Ativas</h4>
                <div id="tarefasAtivas" class="space-y-3"></div>
            </div>

            <!-- Tarefas Concluídas -->
            <div>
                <h4 class="text-green-600 font-medium mb-3">Concluídas</h4>
                <div id="tarefasConcluidas" class="space-y-3"></div>
            </div>

            <!-- Tarefas Canceladas -->
            <div>
                <h4 class="text-red-600 font-medium mb-3">Canceladas</h4>
                <div id="tarefasCanceladas" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Membro -->
    <div id="modalAdicionarMembro" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Adicionar Membro</h3>
                <button onclick="document.getElementById('modalAdicionarMembro').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <form id="formAdicionarMembro" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="selectUsuario" class="block text-sm font-medium text-gray-700">Selecione o Usuário</label>
                    <select id="selectUsuario" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option selected disabled>Escolha um usuário</option>
                    </select>
                </div>
                <div id="mensagem-resposta" class="text-sm hidden"></div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('modalAdicionarMembro').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="button" onclick="adicionarMembro({{ projeto_id }})" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                        Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Botão do Chat -->
    <button onclick="document.getElementById('chatModal').classList.remove('hidden')"
            class="fixed bottom-6 right-6 z-50 w-14 h-14 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center">
        <i class="bi bi-chat-dots-fill text-xl"></i>
    </button>

    <!-- Modal do Chat -->
    <div id="chatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-2xl">
            <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-semibold">Chat do Projeto</h3>
                <button onclick="document.getElementById('chatModal').classList.add('hidden')" class="text-white hover:text-blue-200">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div id="chatBox" class="p-4 h-96 overflow-y-auto"></div>
            
            <div class="border-t border-gray-200 p-4">
                <form id="chatForm" class="flex space-x-2">
                    {% csrf_token %}
                    <input type="text" id="mensagemInput" placeholder="Digite sua mensagem" 
                           class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Enviar
                    </button>
                </form>
                <div id="message" class="hidden mt-2 text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Preloader -->
    <div id="preloader" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="w-3/4">
            <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                <div id="barraProgresso" class="h-full bg-blue-500 animate-pulse" style="width: 0%"></div>
            </div>
        </div>
    </div>

</div>

{% load static %}
<script src="{% static 'projeto_service/js/script.js' %}"></script>
<script>
    token = localStorage.getItem('token');
</script>

<script>
    /**
     * Busca a sigla de um órgão a partir do seu ID.
     *
     * A função faz uma requisição assíncrona à API de órgãos utilizando o ID fornecido
     * e retorna a sigla correspondente ao órgão.
     *
     * @param {number} id - O ID do órgão a ser buscado.
     * @returns {Promise<string>} - Uma Promise que resolve com a sigla do órgão.
     */
    async function carregarOrgao(id) {
        const response_entidade = await fetch(`/api/v1/orgaos/${id}`)
        const entidade = await response_entidade.json()
        let sigla = entidade.sigla
        if (sigla) {
            return sigla
        }
        return "Sem atribuição"
    }


    </script>

    <script>
        /**
         * Busca a sigla de um órgão a partir do seu ID.
         *
         * A função faz uma requisição assíncrona à API de órgãos utilizando o ID fornecido
         * e retorna a sigla correspondente ao órgão.
         *
         * @returns {Promise<string>} - Uma Promise que resolve com a sigla do órgão.
         * @param tarefas
         */
        function carregarTarefasProjeto(tarefas) {
            var listaTarefas = document.getElementById('listaTarefas')
            tarefas.forEach(tarefa => {
                const card = document.createElement("div");
                console.log(tarefa)
                card.className = "card p-2 shadow-sm hover-grow";
                card.innerHTML = `
                <a href="{{SITE_URL}}/site/tarefas/editar-tarefa/${tarefa.id}/" class="text-decoration-none text-dark">
                    <h6>${tarefa.nome}</h6>
                    <p class="mb-1">${tarefa.descricao}</p>
                    <small>Entrega: ${tarefa.data_final}</small>
                </a>
            `;

                if (tarefa.status === "Concluída") {
                    document.getElementById("tarefasConcluidas").appendChild(card);
                } else if (tarefa.status === "Cancelada") {
                    document.getElementById("tarefasCanceladas").appendChild(card);
                } else {
                    document.getElementById("tarefasAtivas").appendChild(card);
                }
            });
        }
    </script>

    <script>
        /**
         * Preenche a tabela de tarefas de um projeto na interface HTML.
         *
         * Para cada tarefa recebida, cria uma linha (<tr>) com as seguintes informações:
         * nome, descrição, status fixo ("Em andamento"), data de início, data final e responsável.
         * Cada linha é adicionada na tabela com id 'listaTarefas'.
         *
         * @param {Array} tarefas - Lista de objetos de tarefas, onde cada tarefa deve conter:
         *  - nome {string}
         *  - descricao {string}
         *  - data_inicio {string}
         *  - data_final {string}
         *  - responsavel_id {number}
         *
         * @returns {void}
         */

        async function carregarProjeto() {
            const response = await fetch('../../../../api/v1/projetos/{{ projeto_id }}', {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${token}`,  // envia o token no header Authorization
                }
            })//Nesse caso passamos o id do projeto, por conta do router, ele vai fazer um get naquele projeto.
            const projeto = await response.json()
            esperar(300).then(async () => {
                //Aqui passamos o id do input no form e falo que o valor dele é o nome/descricao/data... do projeto
                document.getElementById("nome").textContent = projeto.nome
                document.getElementById("descricao").textContent = projeto.descricao
                document.getElementById("dataInicio").innerHTML = `<strong>Data de Início:</strong> ${projeto.data_inicio}`
                document.getElementById("dataFinal").innerHTML = `<strong>Data de Início:</strong> ${projeto.data_final}`

                document.getElementById("desenvolvedor").innerHTML = "<strong>Desenvolvedor: </strong>" + (await carregarResponsavel(projeto.desenvolvedor_id))
                document.getElementById("analista").innerHTML = "<strong>Analista: </strong>" + (await carregarResponsavel(projeto.analista_id))
                document.getElementById("orgao").innerHTML = "<strong>Órgão: </strong>" + (await carregarOrgao(projeto.orgao_id))
                document.getElementById("status").innerHTML = "<strong>Status:</strong> " + projeto.status

                carregarTarefasProjeto(projeto.tarefas)

            })

        }


    </script>

    <script>

        const form = document.getElementById('chatForm');
        const formData = new FormData(form);

        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const msg = document.getElementById('mensagemInput').value;
            if (!msg) return;

            const response = await fetch(`../../../../api/v1/projetos/{{ projeto_id }}/mensagens/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${token}`,  // envia o token no header Authorization
                },
                credentials: 'include',
                body: JSON.stringify({conteudo: msg, user_id: usuario.id})
            });
            document.getElementById('mensagemInput').value = '';
            await carregarMensagens(); // Recarrega as mensagens

            if (response.status === 403) {
                const data = await response.json();
                exibirMensagem(data.detail)
            } else {
                exibirMensagem('Mensagem enviada');
            }
        });

    </script>

    <script>
        async function carregarMensagens() {
            const res = await fetch(`../../../../api/v1/projetos/{{ projeto_id }}/mensagens/`,
                {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Token ${token}`,  // envia o token no header Authorization
                    }
                }
            );
            const mensagens = await res.json();

            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = '';
            for (const msg of mensagens) {
                var autor = await carregarResponsavel(msg.user_id)
                const p = document.createElement('p');
                p.innerHTML = `<strong> ${autor}:</strong> ${msg.conteudo}`;
                chatBox.appendChild(p);
            }

            chatBox.scrollTop = chatBox.scrollHeight; // Scroll automático
        }

        window.onload = carregarProjeto(), carregarMensagens();
    </script>



    <script>
        function esperar(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>

    <script>
        window.onload = function () {
            const barra = document.getElementById('barraProgresso');
            const preloader = document.getElementById('preloader');

            // Faz a barra preencher de forma suave
            barra.style.transition = 'width 300ms ease-in-out';
            barra.style.width = '100%';

            // Esconde o preloader após 300ms
            setTimeout(() => {
                preloader.style.transition = 'opacity 300ms ease';
                preloader.style.opacity = 0;
                setTimeout(() => {
                    preloader.style.display = 'none';
                    preloader.style.position = 'relative'
                }, 300); // tempo para a transição de opacidade
            }, 300);
        }
    </script>


    <script>
        /**
         * Busca o nome de usuário (username) de um responsável pelo seu ID.
         *
         * A função faz uma requisição assíncrona à API de atores, utilizando o ID fornecido,
         * e retorna o nome de usuário (username) associado ao responsável.
         *
         * @param {number} id - O ID do responsável a ser buscado.
         * @returns {Promise<string>} - Uma Promise que resolve com o nome de usuário do responsável.
         */
        async function carregarResponsavel(id) {
            const response_entidade = await fetch(`/api/v1/atores/${id}`)
            const entidade = await response_entidade.json()
            let nome = entidade.username

            if (nome) {
                return nome
            }
            return "Sem atribuição"
        }

    </script>


    <script>
        function mostrarFormulario() {
            const form = document.getElementById("formulario-membro");
            form.style.display = form.style.display === "none" ? "block" : "none";
        }

        async function adicionarMembro(projetoId) {
            const userId = document.getElementById("selectUsuario").value;
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const response = await fetch(`/api/v1/projetos/${projetoId}/adicionar_membro/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'Authorization': `Token ${token}`
                },
                body: JSON.stringify({user_id: userId}),
                credentials: 'include'
            });

            const mensagem = document.getElementById("mensagem-resposta");

            if (response.ok) {
                mensagem.innerText = "Membro adicionado com sucesso!";
                mensagem.style.color = "green";
            } else {
                const erro = await response.json();
                mensagem.innerText = erro.detail || "Erro ao adicionar membro.";
                mensagem.style.color = "red";
            }
        }
    </script>

    <script>

        carregarDesenvolvedorForm()
    </script>


{% endblock %}
