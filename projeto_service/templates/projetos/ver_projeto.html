{% extends "../base/base.html" %}
{% block template %}
    <!-- Conteúdo Principal -->

    <div class="container mt-4">

        <!-- Botão flutuante para adicionar membro -->
        <button type="button" class="btn btn-success rounded-circle shadow-lg"
                style="position: fixed; bottom: 100px; right: 30px; z-index: 1055; width: 60px; height: 60px;"
                data-bs-toggle="modal" data-bs-target="#modalAdicionarMembro"
                title="Adicionar Membro">
            <i class="bi bi-person-plus fs-4"></i>
        </button>

        <!-- Modal Bootstrap -->
        <div class="modal fade" id="modalAdicionarMembro" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">

                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">Adicionar Membro</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>

                    <div class="modal-body">
                        <form id="formAdicionarMembro">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="selectUsuario" class="form-label">Selecione o Usuário</label>
                                <select id="selectUsuario" class="form-select">
                                    <option selected disabled>Escolha um usuário</option>
                                </select>
                            </div>
                            <div id="mensagem-resposta" class="mt-2"></div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success" onclick="adicionarMembro({{ projeto_id }})">
                            Adicionar
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Título do Projeto -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="fw-bold" id="nome">Nome do Projeto</h2>
                <p class="text-muted" id="descricao">Descrição breve do projeto...</p>
            </div>
        </div>

        <!-- Detalhes do Projeto -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Detalhes do Projeto</h5>
                        <p id='dataInicio'></p>
                        <p id='dataFinal'></p>
                        <p id="status"></p>
                    </div>
                </div>
            </div>

            <!-- Responsáveis -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Responsáveis</h5>
                        <ul class="list-group list-group-flush" id="listaResponsaveis">
                            <li class="list-group-item" id="desenvolvedor"></li>
                            <li class="list-group-item" id="analista"></li>
                            <li class="list-group-item" id="orgao"></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarefas do Projeto -->
        <div class="row mb-4">
            <div class="col">
                <div class="card shadow-sm">
                    <div class="card-body">

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="card-title">Tarefas do Projeto</h4>
                            <a href="../../../tarefas/cadastrar_tarefa/{{ projeto_id }}">
                                <button class="btn btn-success">Criar nova tarefa</button>
                            </a>
                        </div>

                        <div class="row">
                            <!-- Tarefas Ativas -->
                            <div class="col-md-4">
                                <h5 class="text-primary">Ativas</h5>
                                <div id="tarefasAtivas" class="d-flex flex-column gap-2"></div>
                            </div>

                            <!-- Tarefas Concluídas -->
                            <div class="col-md-4">
                                <h5 class="text-success">Concluídas</h5>
                                <div id="tarefasConcluidas" class="d-flex flex-column gap-2"></div>
                            </div>

                            <!-- Tarefas Atrasadas -->
                            <div class="col-md-4">
                                <h5 class="text-danger">Canceladas</h5>
                                <div id="tarefasCanceladas" class="d-flex flex-column gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <button type="button" class="btn btn-primary rounded-circle shadow-lg"
                style="position: fixed; bottom: 30px; right: 30px; z-index: 1055; width: 60px; height: 60px;"
                data-bs-toggle="modal" data-bs-target="#chatModal">
            <i class="bi bi-chat-dots-fill fs-4"></i>
        </button>

    </div>

    <!-- Modal do Chat -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="chatModalLabel">Chat do Projeto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" id="chatBox" style="height: 300px; overflow-y: auto;">
                    <!-- Mensagens aparecerão aqui -->
                </div>
                <div class="modal-footer">
                    <form id="chatForm" class="w-100">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" class="form-control" id="mensagemInput"
                                   placeholder="Digite sua mensagem">
                            <button class="btn btn-primary" type="submit">Enviar</button>
                        </div>
                        <div id="message" class="alert d-none mt-2"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="preloader" class="top-0 start-0 w-100 h-100 bg-white d-flex justify-content-center align-items-center"
         style="z-index: 1050; position: fixed">
        <div class="w-75">
            <div class="progress">
                <div id="barraProgresso" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 0;" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
    </div>

    {% load static %}
    <script src="{% static 'projeto_service/js/script.js' %}"></script>
    <script>
        token = localStorage.getItem('token');
    </script>

    <script>
        /**
         * Busca a sigla de um órgão a partir do seu ID.
         *
         * A função faz uma requisição assíncrona à API de órgãos utilizando o ID fornecido
         * e retorna a sigla correspondente ao órgão.
         *
         * @param {number} id - O ID do órgão a ser buscado.
         * @returns {Promise<string>} - Uma Promise que resolve com a sigla do órgão.
         */
        async function carregarOrgao(id) {
            const response_entidade = await fetch(`/api/v1/orgaos/${id}`)
            const entidade = await response_entidade.json()
            let sigla = entidade.sigla
            if (sigla) {
                return sigla
            }
            return "Sem atribuição"
        }


    </script>

    <script>
        /**
         * Busca a sigla de um órgão a partir do seu ID.
         *
         * A função faz uma requisição assíncrona à API de órgãos utilizando o ID fornecido
         * e retorna a sigla correspondente ao órgão.
         *
         * @returns {Promise<string>} - Uma Promise que resolve com a sigla do órgão.
         * @param tarefas
         */
        function carregarTarefasProjeto(tarefas) {
            var listaTarefas = document.getElementById('listaTarefas')
            tarefas.forEach(tarefa => {
                const card = document.createElement("div");
                console.log(tarefa)
                card.className = "card p-2 shadow-sm hover-grow";
                card.innerHTML = `
                <a href="{{SITE_URL}}/site/tarefas/editar-tarefa/${tarefa.id}/" class="text-decoration-none text-dark">
                    <h6>${tarefa.nome}</h6>
                    <p class="mb-1">${tarefa.descricao}</p>
                    <small>Entrega: ${tarefa.data_final}</small>
                </a>
            `;

                if (tarefa.status === "Concluída") {
                    document.getElementById("tarefasConcluidas").appendChild(card);
                } else if (tarefa.status === "Cancelada") {
                    document.getElementById("tarefasCanceladas").appendChild(card);
                } else {
                    document.getElementById("tarefasAtivas").appendChild(card);
                }
            });
        }
    </script>

    <script>
        /**
         * Preenche a tabela de tarefas de um projeto na interface HTML.
         *
         * Para cada tarefa recebida, cria uma linha (<tr>) com as seguintes informações:
         * nome, descrição, status fixo ("Em andamento"), data de início, data final e responsável.
         * Cada linha é adicionada na tabela com id 'listaTarefas'.
         *
         * @param {Array} tarefas - Lista de objetos de tarefas, onde cada tarefa deve conter:
         *  - nome {string}
         *  - descricao {string}
         *  - data_inicio {string}
         *  - data_final {string}
         *  - responsavel_id {number}
         *
         * @returns {void}
         */

        async function carregarProjeto() {
            const response = await fetch('../../../../api/v1/projetos/{{ projeto_id }}', {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${token}`,  // envia o token no header Authorization
                }
            })//Nesse caso passamos o id do projeto, por conta do router, ele vai fazer um get naquele projeto.
            const projeto = await response.json()
            esperar(300).then(async () => {
                //Aqui passamos o id do input no form e falo que o valor dele é o nome/descricao/data... do projeto
                document.getElementById("nome").textContent = projeto.nome
                document.getElementById("descricao").textContent = projeto.descricao
                document.getElementById("dataInicio").innerHTML = `<strong>Data de Início:</strong> ${projeto.data_inicio}`
                document.getElementById("dataFinal").innerHTML = `<strong>Data de Início:</strong> ${projeto.data_final}`

                document.getElementById("desenvolvedor").innerHTML = "<strong>Desenvolvedor: </strong>" + (await carregarResponsavel(projeto.desenvolvedor_id))
                document.getElementById("analista").innerHTML = "<strong>Analista: </strong>" + (await carregarResponsavel(projeto.analista_id))
                document.getElementById("orgao").innerHTML = "<strong>Órgão: </strong>" + (await carregarOrgao(projeto.orgao_id))
                document.getElementById("status").innerHTML = "<strong>Status:</strong> " + projeto.status

                carregarTarefasProjeto(projeto.tarefas)

            })

        }


    </script>

    <script>

        const form = document.getElementById('chatForm');
        const formData = new FormData(form);

        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const msg = document.getElementById('mensagemInput').value;
            if (!msg) return;

            const response = await fetch(`../../../../api/v1/projetos/{{ projeto_id }}/mensagens/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${token}`,  // envia o token no header Authorization
                },
                credentials: 'include',
                body: JSON.stringify({conteudo: msg, user_id: usuario.id})
            });
            document.getElementById('mensagemInput').value = '';
            await carregarMensagens(); // Recarrega as mensagens

            if (response.status === 403) {
                const data = await response.json();
                exibirMensagem(data.detail)
            } else {
                exibirMensagem('Mensagem enviada');
            }
        });

    </script>

    <script>
        async function carregarMensagens() {
            const res = await fetch(`../../../../api/v1/projetos/{{ projeto_id }}/mensagens/`,
                {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Token ${token}`,  // envia o token no header Authorization
                    }
                }
            );
            const mensagens = await res.json();

            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = '';
            for (const msg of mensagens) {
                var autor = await carregarResponsavel(msg.user_id)
                const p = document.createElement('p');
                p.innerHTML = `<strong> ${autor}:</strong> ${msg.conteudo}`;
                chatBox.appendChild(p);
            }

            chatBox.scrollTop = chatBox.scrollHeight; // Scroll automático
        }

        window.onload = carregarProjeto(), carregarMensagens();
    </script>



    <script>
        function esperar(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>

    <script>
        window.onload = function () {
            const barra = document.getElementById('barraProgresso');
            const preloader = document.getElementById('preloader');

            // Faz a barra preencher de forma suave
            barra.style.transition = 'width 300ms ease-in-out';
            barra.style.width = '100%';

            // Esconde o preloader após 300ms
            setTimeout(() => {
                preloader.style.transition = 'opacity 300ms ease';
                preloader.style.opacity = 0;
                setTimeout(() => {
                    preloader.style.display = 'none';
                    preloader.style.position = 'relative'
                }, 300); // tempo para a transição de opacidade
            }, 300);
        }
    </script>


    <script>
        /**
         * Busca o nome de usuário (username) de um responsável pelo seu ID.
         *
         * A função faz uma requisição assíncrona à API de atores, utilizando o ID fornecido,
         * e retorna o nome de usuário (username) associado ao responsável.
         *
         * @param {number} id - O ID do responsável a ser buscado.
         * @returns {Promise<string>} - Uma Promise que resolve com o nome de usuário do responsável.
         */
        async function carregarResponsavel(id) {
            const response_entidade = await fetch(`/api/v1/atores/${id}`)
            const entidade = await response_entidade.json()
            let nome = entidade.username

            if (nome) {
                return nome
            }
            return "Sem atribuição"
        }

    </script>


    <script>
        function mostrarFormulario() {
            const form = document.getElementById("formulario-membro");
            form.style.display = form.style.display === "none" ? "block" : "none";
        }

        async function adicionarMembro(projetoId) {
            const userId = document.getElementById("selectUsuario").value;
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const response = await fetch(`/api/v1/projetos/${projetoId}/adicionar_membro/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'Authorization': `Token ${token}`
                },
                body: JSON.stringify({user_id: userId}),
                credentials: 'include'
            });

            const mensagem = document.getElementById("mensagem-resposta");

            if (response.ok) {
                mensagem.innerText = "Membro adicionado com sucesso!";
                mensagem.style.color = "green";
            } else {
                const erro = await response.json();
                mensagem.innerText = erro.detail || "Erro ao adicionar membro.";
                mensagem.style.color = "red";
            }
        }
    </script>

    <script>

        carregarDesenvolvedorForm()
    </script>


{% endblock %}
