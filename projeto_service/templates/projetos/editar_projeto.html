{% extends "../base/base.html" %}
{% block template %}
<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Editar Projeto <strong>{{ projeto_id }}</strong></h1>
    </div>

    <div class="flex justify-center">
        <div class="w-full max-w-2xl bg-white rounded-lg shadow-md p-6">
            <form id="formProjeto" class="space-y-6">
                {% csrf_token %}

                <!-- Campo Nome do Projeto -->
                <div>
                    <label for="inputName" class="block text-sm font-medium text-gray-700">Nome do Projeto</label>
                    <input type="text" id="inputName" name="inputName" maxlength="50" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                        O nome do projeto deve ter entre 1 e 50 caracteres.
                    </div>
                    <div class="text-right text-sm text-gray-500 mt-1">
                        <span id="nomeCounter">0</span>/50 caracteres
                    </div>
                </div>

                <!-- Campo Descrição -->
                <div>
                    <label for="descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="descricao" name="descricao" rows="3" required
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                        Por favor, insira uma descrição.
                    </div>
                </div>

                <!-- Datas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="dataInicio" class="block text-sm font-medium text-gray-700">Data Inicial</label>
                        <input type="date" id="dataInicio" name="dataInicio" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                            Por favor, selecione a data inicial.
                        </div>
                    </div>
                    <div>
                        <label for="dataFinal" class="block text-sm font-medium text-gray-700">Data Final</label>
                        <input type="date" id="dataFinal" name="dataFinal" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                            Por favor, selecione a data final.
                        </div>
                    </div>
                </div>

                <!-- Atribuições -->
                <div class="space-y-4">
                    <h5 class="text-center text-lg font-medium text-gray-700">Atribuições</h5>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Órgão -->
                        <div>
                            <label for="orgaoId" class="block text-sm font-medium text-gray-700">Órgão</label>
                            <select id="orgaoId" name="orgaoId" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="" selected disabled>Selecione</option>
                            </select>
                            <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                                Por favor, selecione um órgão.
                            </div>
                        </div>

                        <!-- Analista -->
                        <div>
                            <label for="analista" class="block text-sm font-medium text-gray-700">Analista</label>
                            <select id="analista" name="analista" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="" selected disabled>Selecione</option>
                            </select>
                            <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                                Por favor, selecione um analista.
                            </div>
                        </div>

                        <!-- Desenvolvedor -->
                        <div>
                            <label for="desenvolvedor" class="block text-sm font-medium text-gray-700">Desenvolvedor</label>
                            <select id="desenvolvedor" name="desenvolvedor" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="" selected disabled>Selecione</option>
                            </select>
                            <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                                Por favor, selecione um desenvolvedor.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões -->
                <div class="flex justify-between">
                    <a href="../" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </a>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                        Salvar Alterações
                    </button>
                </div>
            </form>

            <!-- Preloader -->
            <div id="preloader" class="hidden fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
                <div class="w-3/4">
                    <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                        <div id="barraProgresso" class="h-full bg-blue-500 animate-pulse" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Mensagem de Feedback -->
            <div id="message" class="hidden mt-4 p-4 rounded"></div>
        </div>
    </div>
</div>

<script>
    async function carregarOrgaoForm() {
        const response_orgaos = await fetch('/api/v1/orgaos')
        const orgaos = await response_orgaos.json()

        formOrgao = document.getElementById('orgaoId')
        formOrgao.innerHTML = '<option value="" selected disabled>Selecione</option> '

        orgaos.forEach(orgao => {
            let opcao = document.createElement('option')//criando uma nova tag <option>
            opcao.value = orgao.id
            opcao.textContent = orgao.sigla
            formOrgao.appendChild(opcao) // adiciona no final o orgão
        })
    }

    carregarOrgaoForm()
</script>
{% comment %}PEGAR OS PROJETOS E COLOCAR NO SELECT{% endcomment %}
<script>
    async function carregarAnalistaForm() {
        const response_entidade = await fetch('/api/v1/atores')

        const entidades = await response_entidade.json()
        formEntidade = document.getElementById('analista')//TROCAR PELO ID DO FORM
        formEntidade.innerHTML = '<option value="" selected disabled>Selecione</option> '

        entidades.forEach(entidade => {
            let opcao = document.createElement('option')//criando uma nova tag <option>
            opcao.value = entidade.id
            opcao.textContent = entidade.username
            formEntidade.appendChild(opcao) // adiciona no final o orgão
        })
    }

    carregarAnalistaForm()
</script>

<script>
    async function carregarDesenvolvedorForm() {
        const response_entidade = await fetch('/api/v1/atores')

        const entidades = await response_entidade.json()
        formEntidade = document.getElementById('desenvolvedor')//TROCAR PELO ID DO FORM
        formEntidade.innerHTML = '<option value="" selected disabled>Selecione</option> '

        entidades.forEach(entidade => {
            let opcao = document.createElement('option')//criando uma nova tag <option>
            opcao.value = entidade.id
            opcao.textContent = entidade.username
            formEntidade.appendChild(opcao) // adiciona no final o orgão
        })
    }

    carregarDesenvolvedorForm()
</script>

<script>

    async function carregarProjetoNoForm() {
        const response = await fetch('../../../../api/v1/projetos/{{ projeto_id }}')//Nesse caso passamos o id do projeto, por conta do router, ele vai fazer um get naquele projeto.
        const projeto = await response.json()

        esperar(300).then(() => {
            //Aqui passamos o id do input no form e falo que o valor dele é o nome/descricao/data... do projeto
            document.getElementById("inputName").value = projeto.nome
            document.getElementById("descricao").value = projeto.descricao
            document.getElementById("dataInicio").value = desformatarData(projeto.data_inicio)
            document.getElementById("dataFinal").value = desformatarData(projeto.data_final)
            document.getElementById("orgaoId").value = projeto.orgao_id
            document.getElementById("analista").value = projeto.analista_id
            document.getElementById("desenvolvedor").value = projeto.desenvolvedor_id
        })

    }

    window.onload = carregarProjetoNoForm()

    // Contador de caracteres para o nome do projeto

    function esperar(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    document.getElementById('inputName').addEventListener('input', function () {
        const counter = document.getElementById('nomeCounter');
        const currentLength = this.value.length;
        counter.textContent = currentLength;

        // Altera a cor se aproximar do limite
        if (currentLength > 45) {
            counter.classList.add('text-warning');
            if (currentLength >= 50) {
                counter.classList.remove('text-warning');
                counter.classList.add('text-danger');
            }
        } else {
            counter.classList.remove('text-warning', 'text-danger');
        }
    });

    // Validação do tamanho do nome antes do envio
    document.getElementById('formProjeto').addEventListener('submit', function (event) {
        const nomeProjeto = document.getElementById('inputName').value;

        if (nomeProjeto.length > 50) {
            event.preventDefault();
            const input = document.getElementById('inputName');
            input.classList.add('is-invalid');

            exibirMensagem('O nome do projeto não pode exceder 50 caracteres.', false);
            return;
        }

        // Restante da lógica de submit permanece igual...
    });

    /**
     * Função para formatar a data de YYYY-MM-DD para DD/MM/YYYY
     * @param {string} data - Data no formato YYYY-MM-DD
     * @returns {string} Data formatada ou string vazia se inválida
     */
    function formatarData(data) {
        if (!data) return "";
        const partes = data.split("-");
        if (partes.length !== 3) return data; // Retorna original se formato inválido
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
    }

    function desformatarData(data) {
        if (!data) return "";
        const partes = data.split("/");
        if (partes.length !== 3) return data; // Retorna original se formato inválido
        return `${partes[2]}-${partes[1]}-${partes[0]}`;
    }

    /**
     * Função para validar se a data final é maior que a data inicial
     * @param {string} inicio - Data inicial no formato YYYY-MM-DD
     * @param {string} fim - Data final no formato YYYY-MM-DD
     * @returns {boolean} Verdadeiro se a data final é válida
     */
    function validarDatas(inicio, fim) {
        if (!inicio || !fim) return true; // Validação básica já feita pelo required
        return new Date(fim) >= new Date(inicio);
    }

    /**
     * Função para exibir mensagem de feedback
     * @param {string} mensagem - Texto da mensagem
     * @param {boolean} sucesso - Indica se é uma mensagem de sucesso
     */
    function exibirMensagem(mensagem, sucesso = true) {
        const elemento = document.getElementById('message');
        elemento.textContent = mensagem;
        elemento.classList.remove('d-none', 'alert-success', 'alert-danger');
        elemento.classList.add(sucesso ? 'alert-success' : 'alert-danger');

        // Remove a mensagem após 5 segundos
        setTimeout(() => {
            elemento.classList.add('d-none');
        }, 5000);
    }

    // Evento de submissão do formulário
    document.getElementById('formProjeto').addEventListener('submit', async function (event) {
        event.preventDefault();

        // Validação do formulário
        const form = this;
        if (!form.checkValidity()) {
            event.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        // Validação das datas
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFinal = document.getElementById('dataFinal').value;

        if (!validarDatas(dataInicio, dataFinal)) {
            exibirMensagem('A data final deve ser maior ou igual à data inicial.', false);
            return;
        }

        // Preparação dos dados
        const formData = new FormData(form);

        try {
            // Envio dos dados para a API
            const response = await fetch(`/api/v1/projetos/{{ projeto_id }}/`, {
                method: 'PUT',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nome: formData.get('inputName'),
                    descricao: formData.get('descricao'),
                    data_inicio: formatarData(dataInicio),
                    data_final: formatarData(dataFinal),
                    orgao_id: formData.get('orgaoId'),
                    analista_id: formData.get('analista'),
                    desenvolvedor_id: formData.get('desenvolvedor')
                }),
            });

            const data = await response.json();

            if (response.ok) {
                exibirMensagem('Projeto editado com sucesso!');
                form.classList.remove('was-validated');
            } else {
                // Exibe mensagem de erro da API ou padrão
                const erro = data.error || data.message || 'Erro na edição do projeto';
                exibirMensagem(erro, false);
            }
        } catch (error) {
            console.error('Erro:', error);
            exibirMensagem('Erro ao conectar com o servidor.', false);
        }
    });

</script>

<script>
    window.onload = function () {
        const barra = document.getElementById('barraProgresso');
        const preloader = document.getElementById('preloader');

        // Faz a barra preencher de forma suave
        barra.style.transition = 'width 300ms ease-in-out';
        barra.style.width = '100%';

        // Esconde o preloader após 300ms
        setTimeout(() => {
            preloader.style.transition = 'opacity 300ms ease';
            preloader.style.opacity = 0;
            setTimeout(() => {
                preloader.style.display = 'none';
                preloader.style.position = 'relative'
            }, 300); // tempo para a transição de opacidade
        }, 300);
    }
</script>
<style>
    /* Estilo opcional para o contador */
    .text-warning {
        color: orange;
        font-weight: bold;
    }

    .text-danger {
        color: red;
        font-weight: bold;
    }
</style>

{% endblock %}