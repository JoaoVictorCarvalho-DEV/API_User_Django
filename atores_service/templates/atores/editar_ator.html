{% extends "../base/base.html" %}
{% block template %}
<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Editar Ator <strong>{{ ator_id }}</strong></h1>
    </div>

    <div class="flex justify-center">
        <div class="w-full max-w-md bg-white rounded-lg shadow-md p-6">
            <h3 id="nome" class="text-xl font-semibold mb-2"></h3>
            <h3 id="email" class="text-gray-600 mb-2"></h3>
            <h3 id="orgao" class="text-gray-600 mb-4"></h3>
            <h3 id="telefone" class="text-gray-600 mb-6"></h3>

            <form id="formAtor" class="space-y-4">
                {% csrf_token %}

                <div>
                    <label for="papel" class="block text-sm font-medium text-gray-700">Papel</label>
                    <select id="papel" name="papel" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </select>
                    <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                        Por favor, selecione um papel.
                    </div>
                </div>

                <div class="flex justify-between">
                    <a href="../" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </a>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                        Salvar Alterações
                    </button>
                </div>
            </form>

            <div id="preloader" class="hidden fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
                <div class="w-3/4">
                    <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                        <div id="barraProgresso" class="h-full bg-blue-500 animate-pulse" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="message" class="hidden mt-4 p-3 rounded text-sm"></div>
        </div>
    </div>
</div>

<script>
    async function carregarDadosAtor(userId) {
        try {
            const response = await fetch(`/api/v1/atores/${userId}`);
            const ator = await response.json();
            
            document.getElementById("nome").textContent = ator.username;
            document.getElementById("email").textContent = ator.email;
            document.getElementById("telefone").textContent = ator.telefone;
            
            // Carrega papéis disponíveis
            const responsePapeis = await fetch('/api/v1/atores/papeis/');
            const papeis = await responsePapeis.json();
            
            const select = document.getElementById('papel');
            select.innerHTML = '';
            
            papeis.forEach(papel => {
                const option = document.createElement('option');
                option.value = papel.id;
                option.textContent = papel.papel;
                option.selected = (papel.id === ator.atores_id);
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('Erro:', error);
            exibirMensagem('Erro ao carregar dados do ator', false);
        }
    }

    document.addEventListener('DOMContentLoaded', () => carregarDadosAtor({{ user_id }}));

</script>
{% endblock %}

    {% load static %}
    <script src="{% static 'atores_service/js/script.js' %}"></script>

    <script>

        //Chama a função quando a página carrega
        document.addEventListener('DOMContentLoaded', carregarDadosAtor({{ user_id }}));


        //Evento de submissão do Formulário
        document.getElementById('formAtor').addEventListener('submit', async function (event) {
            event.preventDefault();

            const form = this;
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }

            try {
                //Envio dos dados para a API
                const response = await fetch(`/auth_api/update/{{user_id}}`, {
                    method: 'PUT',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        atores_id: document.getElementById('papel').value
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    exibirMensagem('Ator editado com sucesso!');
                    form.classList.remove('was-validaded');
                } else {
                    const erro = data.error || data.message || 'Erro ao editar o Ator';
                    exibirMensagem(erro, false);
                }

            } catch (error) {
                console.error('Erro: ', error);
                exibirMensagem('Erro ao conectar com o servidor', false);
            }
        });
    </script>

    <script>
        window.onload = function () {
            const barra = document.getElementById('barraProgresso');
            const preloader = document.getElementById('preloader');

            // Faz a barra preencher de forma suave
            barra.style.transition = 'width 300ms ease-in-out';
            barra.style.width = '100%';

            // Esconde o preloader após 300ms
            setTimeout(() => {
                preloader.style.transition = 'opacity 300ms ease';
                preloader.style.opacity = 0;
                setTimeout(() => {
                    preloader.style.display = 'none';
                    preloader.style.position = 'relative'
                }, 300); // tempo para a transição de opacidade

            }, 300);

        }

    </script>

    <script>
        //Redireciona o usuário se aquela página exigir ser um administrador
        const usuario = JSON.parse(localStorage.getItem('user'));
        if (usuario.atores_id !== 1) {
            window.onload = () => {
                window.location.replace("http://127.0.0.1:8000/");
            }
        }
    </script>


    <style>
        /* Estilo opcional para o contador */
        .text-warning {
            color: orange;
            font-weight: bold;
        }

        .text-danger {
            color: red;
            font-weight: bold;
        }
    </style>

{% endblock %}