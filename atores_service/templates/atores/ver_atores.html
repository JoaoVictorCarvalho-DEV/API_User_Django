{% extends "../base/base.html" %}
{% block template %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">
        <i class="bi bi-people-fill mr-2"></i> Atores
    </h1>
    
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="h-[75vh] overflow-y-auto p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="listaItens"></div>
        </div>
    </div>

    <div id="message" class="hidden fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg"></div>
</div>

<script>

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();

                // Verifica se o cookie começa com o nome que queremos
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function exibirMensagem(mensagem, sucesso = true) {
        const elemento = document.getElementById('message');
        elemento.textContent = mensagem;
        elemento.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
        elemento.classList.add('block', sucesso ? 'bg-green-500' : 'bg-red-500');
        
         // Remove a mensagem após 5 segundos
        setTimeout(() => {
            elemento.classList.add('hidden');
        }, 5000);
    }

    async function carregarItens() {
        const response = await fetch('/api/v1/atores');
        const entidades = await response.json();

        const response_orgaos = await fetch('/api/v1/orgaos');
        const orgaos = await response_orgaos.json();

        const listaItens = document.getElementById("listaItens");
        listaItens.innerHTML = '';

        entidades.forEach(entidade => {
            const orgao_nome = (orgaos.find(orgao => orgao.id === entidade.orgao_id) || {}).sigla || 'Sem orgão';
            
            const item = document.createElement('div');
            item.className = 'border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow';
            item.innerHTML = `
                <div class="p-4">
                    <a href='../ver_ator/${entidade.id}' class='block'>
                        <h3 class="text-lg font-semibold text-gray-800">
                            <i class="bi bi-file-person-fill mr-2"></i>${entidade.username}
                        </h3>
                    </a>
                    <div class="mt-3 space-y-2 text-sm text-gray-600">
                        <p><i class="bi bi-envelope-at-fill mr-2"></i>${entidade.email}</p>
                        <p><i class="bi bi-telephone-fill mr-2"></i>${entidade.telefone}</p>
                        <p><i class="bi bi-briefcase-fill mr-2"></i>${orgao_nome}</p>
                    </div>
                    <div class="mt-4">
                        <a href="../editar_ator/${entidade.id}/" class="inline-block px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                            <i class="bi bi-pencil-fill mr-1"></i>Editar
                        </a>
                    </div>
                </div>
            `;
            listaItens.appendChild(item);
        });
    }

    async function deletarItemPorID(id) {
        const response = await fetch(`/api/v1/atores/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        if (response.ok) {
            exibirMensagem("Ator deletado com sucesso!", true);
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            exibirMensagem("Erro ao deletar o ator!", false);
        }
    }

    window.onload = carregarItens;
</script>
{% endblock %}
