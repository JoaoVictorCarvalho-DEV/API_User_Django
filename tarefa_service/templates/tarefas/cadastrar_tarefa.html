{% extends "../base/base.html" %}
{% block template %}
<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="bi bi-card-checklist mr-2"></i> Cadastrar Tarefa
        </h1>
    </div>

    <div class="flex justify-center">
        <div class="w-full max-w-2xl bg-white rounded-lg shadow-md p-6">
            <form id="formTarefa" class="space-y-6">
                {% csrf_token %}
                <input type="hidden" id="projetoId" name="projetoId" value="{{ projeto_id }}">

                <!-- Nome da Tarefa -->
                <div>
                    <label for="inputName" class="block text-sm font-medium text-gray-700">Nome da Tarefa</label>
                    <input type="text" id="inputName" name="inputName" maxlength="50" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                        O nome da tarefa deve ter entre 1 e 50 caracteres.
                    </div>
                    <div class="text-right text-sm text-gray-500 mt-1">
                        <span id="nomeCounter">0</span>/50 caracteres
                    </div>
                </div>

                <!-- Descrição -->
                <div>
                    <label for="descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="descricao" name="descricao" rows="3" required
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                        Por favor, insira uma descrição.
                    </div>
                </div>

                <!-- Datas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="dataInicio" class="block text-sm font-medium text-gray-700">Data Inicial</label>
                        <input type="date" id="dataInicio" name="dataInicio" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                            Por favor, selecione a data inicial.
                        </div>
                    </div>
                    <div>
                        <label for="dataFinal" class="block text-sm font-medium text-gray-700">Data Final</label>
                        <input type="date" id="dataFinal" name="dataFinal" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                            Por favor, selecione a data final.
                        </div>
                    </div>
                </div>

                <!-- Responsável -->
                <div>
                    <label for="responsavel" class="block text-sm font-medium text-gray-700">Responsável</label>
                    <select id="responsavel" name="responsavel" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="" selected disabled>Selecione</option>
                    </select>
                    <div class="invalid-feedback hidden text-red-600 text-sm mt-1">
                        Por favor, selecione um responsável.
                    </div>
                </div>

                <!-- Prioridade -->
                <div>
                    <label for="prioridade" class="block text-sm font-medium text-gray-700">Prioridade</label>
                    <select id="prioridade" name="prioridade" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="" selected disabled>Selecione</option>
                        <option value="Baixa">Baixa</option>
                        <option value="Média">Média</option>
                        <option value="Alta">Alta</option>
                    </select>
                </div>

                <!-- Botão de Envio -->
                <div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md">
                        Cadastrar Tarefa
                    </button>
                </div>
            </form>

            <div id="message" class="hidden mt-4 p-3 rounded text-sm"></div>
        </div>
    </div>
</div>

<script>
    // Carrega responsáveis no select
    async function carregarResponsaveis() {
        const response = await fetch('/api/v1/atores/');
        const responsaveis = await response.json();
        
        const select = document.getElementById('responsavel');
        responsaveis.forEach(responsavel => {
            const option = document.createElement('option');
            option.value = responsavel.id;
            option.textContent = responsavel.username;
            select.appendChild(option);
        });
    }

    // Contador de caracteres
    document.getElementById('inputName').addEventListener('input', function() {
        const counter = document.getElementById('nomeCounter');
        const currentLength = this.value.length;
        counter.textContent = currentLength;

        if (currentLength > 45) {
            counter.classList.add('text-orange-500', 'font-bold');
            if (currentLength >= 50) {
                counter.classList.remove('text-orange-500');
                counter.classList.add('text-red-600');
            }
        } else {
            counter.classList.remove('text-orange-500', 'text-red-600', 'font-bold');
        }
    });

    // Validação
    document.getElementById('formTarefa').addEventListener('submit', function(event) {
        const nomeTarefa = document.getElementById('inputName').value;

        if (nomeTarefa.length > 50) {
            event.preventDefault();
            document.getElementById('inputName').classList.add('border-red-500');
            exibirMensagem('O nome da tarefa não pode exceder 50 caracteres.', false);
            return;
        }
    });

    function exibirMensagem(mensagem, sucesso = true) {
        const elemento = document.getElementById('message');
        elemento.textContent = mensagem;
        elemento.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
        elemento.classList.add('block', sucesso ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800');
        
        setTimeout(() => {
            elemento.classList.add('hidden');
        }, 5000);
    }

    // Evento de submissão
    document.getElementById('formTarefa').addEventListener('submit', async function(event) {
        event.preventDefault();

        const form = this;
        if (!form.checkValidity()) {
            event.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        const formData = new FormData(form);

        try {
            const response = await fetch('/api/v1/tarefas/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nome: formData.get('inputName'),
                    descricao: formData.get('descricao'),
                    data_inicio: formData.get('dataInicio'),
                    data_final: formData.get('dataFinal'),
                    responsavel_id: formData.get('responsavel'),
                    prioridade: formData.get('prioridade'),
                    projeto_id: formData.get('projetoId')
                }),
            });

            const data = await response.json();

            if (response.ok) {
                exibirMensagem('Tarefa cadastrada com sucesso!');
                form.reset();
            } else {
                const erro = data.error || data.message || 'Erro no cadastro da tarefa';
                exibirMensagem(erro, false);
            }
        } catch (error) {
            console.error('Erro:', error);
            exibirMensagem('Erro ao conectar com o servidor.', false);
        }
    });

    window.onload = carregarResponsaveis;
</script>
<script>
        token = localStorage.getItem('token');
</script>

<script>
        async function carregarOrgaoForm(){
        const response_orgaos = await fetch('/api/v1/orgaos')
        const orgaos = await response_orgaos.json()

        formOrgao = document.getElementById('orgaoId')
        formOrgao.innerHTML = '<option value="" selected disabled>Selecione</option> '

        orgaos.forEach(orgao => {
            let opcao = document.createElement('option')//criando uma nova tag <option>
            opcao.value = orgao.id
            opcao.textContent = orgao.sigla
            formOrgao.appendChild(opcao) // adiciona no final o orgão
        })
        }
        carregarOrgaoForm()
</script>
    {% comment %}PEGAR OS PROJETOS E COLOCAR NO SELECT{% endcomment %}
<script>
        async function carregarProjetoForm(){
            const response_entidade = await fetch('/api/v1/projetos',
                {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Token ${token}`,  // envia o token no header Authorization
                    }
                }
            );

            const entidades = await response_entidade.json();
            //console.log(entidades)
            formEntidade = document.getElementById('projeto');//TROCAR PELO ID DO FORM
            formEntidade.innerHTML = '<option value="" selected disabled>Selecione</option> ';

            entidades.forEach(entidade => {
                let opcao = document.createElement('option');//criando uma nova tag <option>
                opcao.value = entidade.id;
                opcao.textContent = entidade.nome;
                formEntidade.appendChild(opcao); // adiciona no final o orgão
            });
            formEntidade.value = {{ projeto_id }};
        }
        carregarProjetoForm();

</script>

<script>
        async function carregarAtoresForm(){
            const response_entidade = await fetch('/api/v1/atores')

            const entidades = await response_entidade.json()
            console.log(entidades)
            formEntidade = document.getElementById('responsavel')//TROCAR PELO ID DO FORM
            formEntidade.innerHTML = '<option value="" selected disabled>Selecione</option> '

            entidades.forEach(entidade => {
                let opcao = document.createElement('option')//criando uma nova tag <option>
                opcao.value = entidade.id
                opcao.textContent = entidade.username
                formEntidade.appendChild(opcao) // adiciona no final o orgão
            })
        }
        carregarAtoresForm()
</script>

<script>
        // Validação do tamanho do nome antes do envio
        document.getElementById('formTarefa').addEventListener('submit', function(event) {
            const nomeTarefa = document.getElementById('inputName').value;

            if (nomeTarefa.length > 50) {
                event.preventDefault();
                const input = document.getElementById('inputName');
                input.classList.add('is-invalid');

                exibirMensagem('O nome da tarefa não pode exceder 50 caracteres.', false);
                return;
            }

            // Restante da lógica de submit permanece igual...
        });
</script>

<script>
        /**
         * Função para formatar a data de YYYY-MM-DD para DD/MM/YYYY
         * @param {string} data - Data no formato YYYY-MM-DD
         * @returns {string} Data formatada ou string vazia se inválida
         */
        function formatarData(data) {
            if (!data) return "";
            const partes = data.split("-");
            if (partes.length !== 3) return data; // Retorna original se formato inválido
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        /**
         * Função para validar se a data final é maior que a data inicial
         * @param {string} inicio - Data inicial no formato YYYY-MM-DD
         * @param {string} fim - Data final no formato YYYY-MM-DD
         * @returns {boolean} Verdadeiro se a data final é válida
         */
        function validarDatas(inicio, fim) {
            if (!inicio || !fim) return true; // Validação básica já feita pelo required
            return new Date(fim) >= new Date(inicio);
        }

        /**
         * Função para exibir mensagem de feedback
         * @param {string} mensagem - Texto da mensagem
         * @param {boolean} sucesso - Indica se é uma mensagem de sucesso
         */
        function exibirMensagem(mensagem, sucesso = true) {
            const elemento = document.getElementById('message');
            elemento.textContent = mensagem;
            elemento.classList.remove('d-none', 'alert-success', 'alert-danger');
            elemento.classList.add(sucesso ? 'alert-success' : 'alert-danger');

            // Remove a mensagem após 5 segundos
            setTimeout(() => {
                elemento.classList.add('d-none');
            }, 5000);
        }
</script>

<script>
        // Evento de submissão do formulário
        document.getElementById('formTarefa').addEventListener('submit', async function(event) {
            event.preventDefault();

            // Validação do formulário
            const form = this;
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }

            // Validação das datas
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFinal = document.getElementById('dataFinal').value;

            if (!validarDatas(dataInicio, dataFinal)) {
                exibirMensagem('A data final deve ser maior ou igual à data inicial.', false);
                return;
            }

            // Preparação dos dados
            const formData = new FormData(form);

            try {
                // Envio dos dados para a API
                const response = await fetch('/api/v1/tarefas/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        'Content-Type': 'application/json',
                        'Authorization': `Token ${token}`,  // envia o token no header Authorization
                    },
                    body: JSON.stringify({
                        nome: formData.get('inputName'),
                        descricao: formData.get('descricao'),
                        data_inicio: formatarData(dataInicio),
                        data_final: formatarData(dataFinal),
                        orgao_id: formData.get('orgao'),
                        projeto_id: formData.get('projeto'),
                        responsavel_id: formData.get('responsavel')
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    exibirMensagem('Tarefa cadastrado com sucesso!');
                    form.reset();
                    form.classList.remove('was-validated');
                } else {
                    // Exibe mensagem de erro da API ou padrão
                    const erro = data.error || data.message || 'Erro no cadastro da tarefa';
                    exibirMensagem(erro, false);
                }
            } catch (error) {
                console.error('Erro:', error);
                exibirMensagem('Erro ao conectar com o servidor.', false);
            }
        });
</script>
<style>
        /* Estilo opcional para o contador */
        .text-warning { color: orange; font-weight: bold; }
        .text-danger { color: red; font-weight: bold; }
</style>
{% endblock %}
